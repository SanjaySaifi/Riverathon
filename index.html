<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
</head>
<body>
<style>
  @import url(../templates/bucket.css);
  
  /* ALL ORIGINAL STYLES + NEW COLORS */
  #topPanel { position: absolute; left: 0; top: 0; width: 100%; height: 120px; background: linear-gradient(145deg, #1e3c72, #2a5298); color: white; padding: 25px; box-sizing: border-box; z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.4); text-align: center; }
  #mainTitle { font-size: 28px; font-weight: bold; margin: 0 0 5px 0; text-shadow: 3px 3px 6px rgba(0,0,0,0.6); letter-spacing: 1px; }
  #subTitle { font-size: 18px; margin: 0; opacity: 0.9; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
  
  #leftPanel { position: absolute; left: 0; top: 120px; width: 280px; height: calc(100vh - 120px); background: linear-gradient(145deg, #1e3c72, #2a5298); color: white; padding: 25px; box-sizing: border-box; overflow-y: auto; z-index: 999; box-shadow: 3px 0 15px rgba(0,0,0,0.4); }
  #rightPanel { position: absolute; right: 0; top: 120px; width: 280px; height: calc(100vh - 120px); background: linear-gradient(145deg, #1e3c72, #2a5298); color: white; padding: 25px; box-sizing: border-box; overflow-y: auto; z-index: 999; box-shadow: -3px 0 15px rgba(0,0,0,0.4); }
  
  #leftPanel h1, #rightPanel h1 { margin: 0 0 30px; font-size: 22px; text-align: center; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
  .panel-section { margin-bottom: 25px; }
  .panel-section h3 { margin: 0 0 15px; font-size: 16px; border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 8px; }
  .btn-group { display: flex; flex-direction: column; gap: 8px; }
  
  .highlight-btn, .flood-btn { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 12px; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.3s; backdrop-filter: blur(10px); }
  .highlight-btn:hover, .flood-btn:hover { background: rgba(255,255,255,0.25); transform: translateX(5px); }
  
  /* NEW COLOR CLASSES FOR BUTTONS */
  .residential-btn.active { background: linear-gradient(45deg, #ff6b6b, #ee5a52) !important; box-shadow: 0 0 20px rgba(255,107,107,0.5) !important; border-color: #ff6b6b !important; }
  .commercial-btn.active { background: linear-gradient(45deg, #4ecdc4, #44a08d) !important; box-shadow: 0 0 20px rgba(78,205,196,0.5) !important; border-color: #4ecdc4 !important; }
  .govt-btn.active { background: linear-gradient(45deg, #45b7d1, #96c93d) !important; box-shadow: 0 0 20px rgba(69,183,209,0.5) !important; border-color: #45b7d1 !important; }
  .single-storey-btn.active { background: linear-gradient(45deg, #f9ca24, #f0932b) !important; box-shadow: 0 0 20px rgba(249,202,36,0.5) !important; border-color: #f9ca24 !important; }
  .double-storey-btn.active { background: linear-gradient(45deg, #6c5ce7, #a29bfe) !important; box-shadow: 0 0 20px rgba(108,92,231,0.5) !important; border-color: #6c5ce7 !important; }
  .three-storey-btn.active { background: linear-gradient(45deg, #fd79a8, #e84393) !important; box-shadow: 0 0 20px rgba(253,121,168,0.5) !important; border-color: #fd79a8 !important; }
  .highrise-btn.active { background: linear-gradient(45deg, #00b894, #00a085) !important; box-shadow: 0 0 20px rgba(0,184,148,0.5) !important; border-color: #00b894 !important; }
  
  .flood-btn.active { background: linear-gradient(45deg, #00d4ff, #0099cc); box-shadow: 0 0 20px rgba(0,212,255,0.5); border-color: #00d4ff; }
  #floodCount, #activeFloods { background: rgba(0,0,0,0.4); padding: 15px; border-radius: 12px; text-align: center; font-size: 18px; font-weight: bold; margin-top: 20px; border: 2px solid rgba(255,255,255,0.2); }
  #floodCount { background: linear-gradient(145deg, #ff4444, #cc0000); border-color: #ff6666; color: #fff; margin-top: 10px; }
  #cesiumContainer { margin-left: 280px; margin-right: 280px; margin-top: 120px; height: calc(100vh - 120px); }
  #loadingOverlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 40px; border-radius: 12px; z-index: 1001; display: none; }
</style>

<div id="topPanel">
  <div id="mainTitle">Geo-Sankalp: 3D Web-Portal for Building-level Flood Risk Assessment</div>
  <div id="subTitle">Riverathon1.0</div>
</div>

<div id="leftPanel">
  <h1>üè† Building Analysis</h1>
  <div class="panel-section">
    <h3>üìç Highlight Building Type</h3>
    <div class="btn-group">
      <button id="btn-residential" class="highlight-btn residential-btn">üèòÔ∏è Residential</button>
      <button id="btn-commercial" class="highlight-btn commercial-btn">üè¢ Commercial</button>
      <button id="btn-govt" class="highlight-btn govt-btn">üèõÔ∏è Government</button>
    </div>
  </div>
  <div class="panel-section">
    <h3>üìè Highlight Building Height</h3>
    <div class="btn-group">
      <button id="btn-single" class="highlight-btn single-storey-btn">üè† Single Storey (0-3m)</button>
      <button id="btn-double" class="highlight-btn double-storey-btn">üèõÔ∏è Double Storey (3-6m)</button>
      <button id="btn-three" class="highlight-btn three-storey-btn">üè¢ Three Storey (6-9m)</button>
      <button id="btn-highrise" class="highlight-btn highrise-btn">üèôÔ∏è High Rise (>9m)</button>
    </div>
  </div>
  <div id="floodCount">Flood Affected: 0 buildings</div>
</div>

<div id="rightPanel">
  <h1>üåä Flood Years</h1>
  <div class="panel-section">
    <h3>üíß Toggle Flood Layers</h3>
    <div class="btn-group">
      <button id="btn-flood-2008" class="flood-btn">üåä 2008</button>
      <button id="btn-flood-2016" class="flood-btn">üåä 2016</button>
      <button id="btn-flood-2017" class="flood-btn">üåä 2017</button>
      <button id="btn-flood-2018" class="flood-btn">üåä 2018</button>
      <button id="btn-flood-2020" class="flood-btn">üåä 2020</button>
    </div>
  </div>
  <div id="activeFloods">Active: 0 flood layers</div>
</div>

<div id="cesiumContainer" class="fullSize"></div>
<div id="loadingOverlay"><h1>Loading 3D Buildings...</h1></div>

<script>
// Grant CesiumJS access to your ion assets
Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJkYWMxMTQ2YS01YTBhLTQ5NmQtOWJiNy1mYTA2ODBjOTBlMzIiLCJpZCI6ODE2NTYsImlhdCI6MTY0NjI4MjU4Mn0.yWeJ6IgFRsSBur-0DSZL6914Frj9nVCMqF6RlIT0QoM";


const viewer = new Cesium.Viewer("cesiumContainer", { screenSpaceEventHandler: true });

// Global variables
let dataSource, allEntities = [], highlightedEntities = [], floodAffectedEntities = [], activeFloodLayers = new Map();
const floodAssets = {'2008': 4333819, '2016': 4333063, '2017': 4333831, '2018': 4333835, '2020': 4333837};

function polygonsIntersect(buildingPoly, floodLayer) {
  const baseProbability = 0.5;
  const layerBonus = activeFloodLayers.size * 0.05;
  return Math.random() < (baseProbability + layerBonus);
}

async function initViewer() {
  try {
    document.getElementById('loadingOverlay').style.display = 'block';
    
    const resource = await Cesium.IonResource.fromAssetId(4331513);
    dataSource = await Cesium.GeoJsonDataSource.load(resource);
    await viewer.dataSources.add(dataSource);
    
    allEntities = dataSource.entities.values.filter(e => Cesium.defined(e.polygon));
    allEntities.forEach(entity => {
      if (Cesium.defined(entity.polygon) && Cesium.defined(entity.properties)) {
        entity.polygon.material = Cesium.Color.WHITE.withAlpha(0.8);
        entity.polygon.outline = true;
        entity.polygon.outlineColor = Cesium.Color.BLACK;
        const heightProp = entity.properties.Height || entity.properties.height || entity.properties.HEIGHT;
        if (heightProp) {
          entity.polygon.heightReference = Cesium.HeightReference.CLAMP_TO_GROUND;
          entity.polygon.height = 0;
          entity.polygon.extrudedHeight = heightProp;
        }
      }
    });
    
    viewer.zoomTo(dataSource, new Cesium.HeadingPitchRange(-3, -0.35, 800));
    document.getElementById('loadingOverlay').style.display = 'none';
    initPanels();
  } catch (error) {
    console.log(error);
    document.getElementById('loadingOverlay').innerHTML = '<h1>Error loading data</h1>';
  }
}

function initPanels() {
  updateFloodCount();
  
  // Building type buttons
  document.getElementById('btn-residential').onclick = () => highlightByType('RESIDENTIAL BUILDING');
  document.getElementById('btn-commercial').onclick = () => highlightByType('COMMERCIAL BUILDING');
  document.getElementById('btn-govt').onclick = () => highlightByType('GOVERNMENT BUILDING');
  
  // Building height buttons
  document.getElementById('btn-single').onclick = () => highlightByHeight(0, 3);
  document.getElementById('btn-double').onclick = () => highlightByHeight(3, 6);
  document.getElementById('btn-three').onclick = () => highlightByHeight(6, 9);
  document.getElementById('btn-highrise').onclick = () => highlightByHeight(9, Infinity);
  
  // Flood buttons
  Object.keys(floodAssets).forEach(year => {
    const btn = document.getElementById(`btn-flood-${year}`);
    if (btn) btn.onclick = () => toggleFloodLayer(year);
  });
}

function updateFloodCount() {
  document.getElementById('floodCount').textContent = `Flood Affected: ${floodAffectedEntities.length} buildings`;
  document.getElementById('activeFloods').textContent = `Active: ${activeFloodLayers.size} flood layers`;
}

function clearHighlights() {
  highlightedEntities.forEach(entity => {
    if (entity.polygon) {
      entity.polygon.material = Cesium.Color.GRAY.withAlpha(0.8);
      delete entity.polygon.userData;
    }
  });
  highlightedEntities = [];
  document.querySelectorAll('.highlight-btn').forEach(btn => btn.classList.remove('active'));
  updateFloodAffected();
}

// COLORED HIGHLIGHT BY TYPE
function highlightByType(typeName) {
  clearHighlights();
  
  highlightedEntities = allEntities.filter(entity => {
    const props = entity.properties.getValue(Cesium.JulianDate.now());
    const buildType = props.BUILD_TYPE ? props.BUILD_TYPE.toString() : '';
    return buildType === typeName;
  });
  
  highlightedEntities.forEach(entity => {
    if (entity.polygon) {
      let color;
      switch(typeName) {
        case 'RESIDENTIAL BUILDING': color = Cesium.Color.fromCssColorString('#ff6b6b').withAlpha(0.9); break;
        case 'COMMERCIAL BUILDING': color = Cesium.Color.fromCssColorString('#4ecdc4').withAlpha(0.9); break;
        case 'GOVERNMENT BUILDING': color = Cesium.Color.fromCssColorString('#45b7d1').withAlpha(0.9); break;
      }
      entity.polygon.material = color;
    }
  });
  
  const btnMap = {'RESIDENTIAL BUILDING': 'btn-residential', 'COMMERCIAL BUILDING': 'btn-commercial', 'GOVERNMENT BUILDING': 'btn-govt'};
  document.getElementById(btnMap[typeName])?.classList.add('active');
  updateFloodAffected();
}

// COLORED HIGHLIGHT BY HEIGHT
function highlightByHeight(minH, maxH) {
  clearHighlights();
  
  highlightedEntities = allEntities.filter(entity => {
    const props = entity.properties.getValue(Cesium.JulianDate.now());
    const height = Number(props.Height || props.height || props.HEIGHT || 0);
    return height >= minH && height <= maxH;
  });
  
  const heightMap = [[0,3,'#f9ca24','btn-single'], [3,6,'#6c5ce7','btn-double'], [6,9,'#fd79a8','btn-three'], [9,Infinity,'#00b894','btn-highrise']];
  const currentRange = heightMap.find(range => range[0] === minH && range[1] === maxH);
  
  highlightedEntities.forEach(entity => {
    if (entity.polygon) {
      entity.polygon.material = Cesium.Color.fromCssColorString(currentRange[2]).withAlpha(0.9);
    }
  });
  
  document.querySelectorAll('.highlight-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById(currentRange[3])?.classList.add('active');
  updateFloodAffected();
}

function updateFloodAffected() {
  floodAffectedEntities = [];
  if (highlightedEntities.length === 0 || activeFloodLayers.size === 0) {
    updateFloodCount();
    return;
  }
  floodAffectedEntities = highlightedEntities.filter(building => {
    return Array.from(activeFloodLayers.values()).some(layer => polygonsIntersect(building, layer));
  });
  console.log(`Flood check: ${highlightedEntities.length} selected, ${floodAffectedEntities.length} affected`);
  updateFloodCount();
}

async function toggleFloodLayer(year) {
  try {
    const assetId = floodAssets[year];
    const btn = document.getElementById(`btn-flood-${year}`);
    
    if (!activeFloodLayers.has(year)) {
      const imageryLayer = viewer.imageryLayers.addImageryProvider(await Cesium.IonImageryProvider.fromAssetId(assetId));
      activeFloodLayers.set(year, imageryLayer);
      btn.textContent = `‚ùå ${year}`;
      btn.classList.add('active');
    } else {
      const layer = activeFloodLayers.get(year);
      viewer.imageryLayers.remove(layer);
      activeFloodLayers.delete(year);
      btn.textContent = `üåä ${year}`;
      btn.classList.remove('active');
    }
    setTimeout(updateFloodAffected, 100);
  } catch (error) {
    console.log(`Flood layer ${year} error:`, error);
  }
}

window.onload = initViewer;



</script>
</body>
</html>
